<!DOCTYPE html>
<html>

<head>
    <title>Debug Report</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 11px;
        }

        * {
            box-sizing: border-box;
        }

        h1,
        h2,
        h3 {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 22px;
        }

        h2 {
            font-size: 18px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 5px;
            /* General rule to prevent headings from being orphaned */
            page-break-after: avoid;
        }

        h3 {
            font-size: 14px;
            margin-top: 15px;
            page-break-after: avoid;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            margin-bottom: 20px;
            /* Allows tables to split */
            page-break-inside: auto;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        thead {
            display: table-header-group;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #f2f2f2;
        }

        /* NEW CSS RULE: For sections that should NOT be split (like image galleries) */
        .section-block {
            page-break-inside: avoid;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo-img {
            max-height: 80px;
            width: auto;
        }

        .image-pipeline {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .pipeline-step {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            width: 48%;
            /* This is still useful to avoid breaking a single image box */
            page-break-inside: avoid;
            margin-bottom: 15px;
        }

        .pipeline-step img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        .summary-plots {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: flex-start;
        }

        .summary-plots>div {
            width: 48%;
            text-align: center;
        }

        .summary-plots img {
            max-width: 100%;
        }

        .debug-table td:last-child {
            word-break: break-all;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <p><strong>Author:</strong> {{ author }}</p>
            <p><strong>Department:</strong> {{ department }}</p>
        </div>
        <div>
            <img src="{{ logo }}" alt="Logo" class="logo-img">
            <p><strong>Date:</strong> {{ today }}</p>
        </div>
    </header>

    <h1>{{ report_title }}</h1>

    <table>
        <tr>
            <th>P/N</th>
            <td>{{ part_number }}</td>
        </tr>
        <tr>
            <th>Thickness</th>
            <td>{{ thickness }}</td>
        </tr>
    </table>

    <!-- CHANGE: Re-added wrapper div ONLY for this image gallery section -->
    {% if debug_data.image_pipeline %}
    <div class="section-block">
        <h2>Image Processing Pipeline</h2>
        <div class="image-pipeline">
            {% for item in debug_data.image_pipeline %}
            <div class="pipeline-step">
                <h3>{{ item.title }}</h3>
                <img src="{{ item.path }}" alt="{{ item.title }}">
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- This section can also be wrapped if it causes issues, but often it's fine. -->
    <div class="section-block">
        <h2>Analysis Summary</h2>
        <div class="summary-plots">
            <div>
                <h3>Color Range</h3>
                <img src="{{ color_space_plot_path }}" alt="Color Space Plot">
            </div>
            <div>
                <h3>Coverage</h3>
                <img src="{{ image3_path }}" alt="Pie Chart">
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <h3>Hue-Saturation Diagram</h3>
            <img src="{{ hsv_diagram_path }}" alt="Hue-Saturation Diagram" style="max-width: 80%;">
        </div>
    </div>

    <!-- CHANGE: NO wrapper div here to allow the table to split -->
    {% if debug_data %}
    <h2>Debug Information</h2>
    <table class="debug-table">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            {% for key, value in debug_data.items() %}
            {% if key != 'image_pipeline' and key != 'symmetry_visualizations' %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ value }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- CHANGE: Re-added wrapper div for this second image gallery section -->
    {% if debug_data.symmetry_visualizations %}
    <div class="section-block">
        <h2>Symmetry Analysis Visualizations</h2>
        <div class="image-pipeline">
            {% for item in debug_data.symmetry_visualizations %}
            <div class="pipeline-step">
                <h3>{{ item.title }}</h3>
                <img src="{{ item.path }}" alt="{{ item.title }}">
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if sample_debug_info %}
    <div class="section-block">
        <h2>Sample Images for Color Range Calculation</h2>
        <div class="image-pipeline">
            {% for sample in sample_debug_info %}
            <div class="pipeline-step">
                <h3>{{ sample.path | basename }}</h3>
                <img src="{{ sample.image_with_points_path }}" alt="Sample Image with Points">
                <p>Method: {{ sample.method }}</p>
                <div style="display: flex; justify-content: center; align-items: center; margin-top: 10px;">
                    <p style="margin-right: 10px;">Average Color:</p>
                    <img src="{{ sample.palette_path }}" alt="Color Palette" style="width: 50px; height: 50px; border: 1px solid #000;">
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</body>

</html>